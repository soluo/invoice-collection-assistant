# 2.9 Réglages

**Fichier** : `src/pages/OrganizationSettings.tsx` (refonte complète)
**Maquette** : `specs/V2/mockups/reglages.html`
**Statut** : ✅ Terminé

---

## Architecture

Page unique sans onglets, avec 3 blocs empilés verticalement (fieldsets).

---

## Tâches

### 2.9.1 Bloc 1 : Profil de l'entreprise
- [x] Section avec titre "Profil de l'entreprise"
- [x] Input : Nom de l'entreprise (édite `organization.name`)
- [x] Bouton "Enregistrer"
- [x] Toast confirmation après sauvegarde

### 2.9.2 Bloc 2 : Connexion Email
- [x] Section avec titre "Connexion du compte email"
- [x] Card Google : Logo + "Connecter avec Google" (placeholder désactivé "Bientôt disponible")
- [x] Card Outlook : Logo + "Connecter avec Outlook" → OAuth fonctionnel
- [x] Si connecté : Afficher email + Bouton "Déconnecter"
- [x] Input optionnel : Nom d'affichage pour l'expéditeur (`senderName`)

### 2.9.3 Bloc 3 : Gestion des relances

#### 2.9.3.1 Sous-bloc : Activation des envois automatiques
- [x] Toggle : "Activer l'envoi automatique des emails de relance"
  - Par défaut : désactivé (`false`)
  - Si désactivé : Les reminders sont toujours créés, mais les emails ne sont pas envoyés
  - Si activé : Les emails sont envoyés automatiquement selon la séquence définie

#### 2.9.3.2 Sous-bloc : Étapes de relance (liste verticale)
- [x] Titre "Séquence de relance"
- [x] Liste verticale des étapes (cards empilées)
  - Chaque card affiche : Délai (ex: "J+7"), Type (Email/Téléphone), Nom de l'étape
  - Tri automatique par nombre de jours croissant
- [x] Configuration par défaut :
  - J+7 : Email "Relance amicale"
  - J+14 : Email "Relance sérieuse"
  - J+30 : Téléphone (Appel manuel à effectuer)
- [x] Boutons d'action par étape :
  - Bouton "Modifier" → Ouvre modal d'édition
  - Bouton "Supprimer" → Confirmation + suppression
- [x] Bouton "Ajouter une étape" → Ouvre modal de création

### 2.9.4 Modal création/édition d'étape
- [x] Titre : "Ajouter une étape" ou "Modifier l'étape"
- [x] Input : Délai (nombre de jours après l'échéance)
- [x] Dropdown : Type d'action
  - Options : "Email", "Téléphone (appel manuel)"
- [x] Input : Nom de l'étape (ex: "Relance amicale")
- [x] Si type = "Email" :
  - [x] Input : Objet de l'email
  - [x] Textarea : Contenu de l'email (corps du message)
- [x] Si type = "Téléphone" :
  - [x] Note informative : "Un reminder sera créé pour effectuer un appel manuel"
- [x] Bouton "Annuler"
- [x] Bouton "Enregistrer" → Valide et ferme modal

### 2.9.5 Validation et sauvegarde
- [x] Enregistrement immédiat par action (pas de bouton global)
- [x] Toast confirmation après chaque action
- [x] Validation :
  - Chaque étape doit avoir un délai unique
  - Le délai doit être > 0
  - Les champs obligatoires doivent être remplis

---

## Backend requis

### 2.9.6 Enrichissement de la table `organizations`
- [x] Ajouter les champs suivants à la table `organizations` :
  - `autoSendEnabled` (boolean, optionnel, défaut: false)
  - `reminderSteps` (array, optionnel)
  - `senderName` (string, optionnel) : Nom d'affichage pour l'expéditeur
- [x] Anciens champs conservés en optionnel pour rétrocompatibilité

**Valeurs par défaut :**
```typescript
autoSendEnabled: false
reminderSteps: [
  { id: "...", delay: 7, type: "email", name: "Relance amicale", emailSubject: "...", emailTemplate: "..." },
  { id: "...", delay: 14, type: "email", name: "Relance sérieuse", emailSubject: "...", emailTemplate: "..." },
  { id: "...", delay: 30, type: "phone", name: "Appel manuel" }
]
```

### 2.9.7 Queries & Mutations
- [x] Query `organizations.getReminderSettings`
- [x] Query `organizations.getCurrentOrganization` (mis à jour avec nouvelle structure)
- [x] Mutation `organizations.updateOrganizationName`
- [x] Mutation `organizations.updateAutoSendEnabled`
- [x] Mutation `organizations.updateReminderSteps`
- [x] Mutation `organizations.addReminderStep`
- [x] Mutation `organizations.updateReminderStep`
- [x] Mutation `organizations.deleteReminderStep`
- [x] Mutation `organizations.updateSenderName`

---

## Notes techniques

- **Tri des étapes** : ✅ Implémenté automatiquement côté backend et frontend
- **Toggle d'envoi automatique** : ✅ Implémenté avec mutation dédiée
- **Validation** : ✅ Frontend + backend avec messages d'erreur
- **Templates par défaut** : ✅ Générés dans `convex/reminderDefaults.ts`
- **Composants** : shadcn Switch, Textarea, Dialog, Card, Input, Label, Select
- **Fichiers créés** :
  - `convex/reminderDefaults.ts` : Helper pour valeurs par défaut
  - `src/components/ReminderStepModal.tsx` : Modal réutilisable
  - `src/pages/OrganizationSettings.tsx` : Page refactorée (595 → 517 lignes)

# 2.9 R√©glages

**Fichier** : `src/pages/Settings.tsx` (refonte)
**Maquette** : `specs/V2/mockups/reglages.html`
**Statut** : üî¥ Non commenc√©

---

## Architecture

Page unique sans onglets, avec 3 blocs empil√©s verticalement (fieldsets).

---

## T√¢ches

### 2.9.1 Bloc 1 : Profil de l'entreprise
- [ ] Section avec titre "Profil de l'entreprise"
- [ ] Input : Nom de l'entreprise (√©dite `workspace.name`)
- [ ] Bouton "Enregistrer"
- [ ] Toast confirmation apr√®s sauvegarde

### 2.9.2 Bloc 2 : Connexion Email
- [ ] Section avec titre "Connexion du compte email"
- [ ] Card Google : Logo + "Connecter avec Google" ‚Üí OAuth
- [ ] Card Outlook : Logo + "Connecter avec Outlook" ‚Üí OAuth
- [ ] Si connect√© : Afficher email + Bouton "D√©connecter"

### 2.9.3 Bloc 3 : Gestion des relances

#### 2.9.3.1 Sous-bloc : Activation des envois automatiques
- [ ] Toggle : "Activer l'envoi automatique des emails de relance"
  - Par d√©faut : d√©sactiv√© (`false`)
  - Si d√©sactiv√© : Les reminders sont toujours cr√©√©s, mais les emails ne sont pas envoy√©s
  - Si activ√© : Les emails sont envoy√©s automatiquement selon la s√©quence d√©finie

#### 2.9.3.2 Sous-bloc : √âtapes de relance (liste verticale)
- [ ] Titre "S√©quence de relance"
- [ ] Liste verticale des √©tapes (cards empil√©es)
  - Chaque card affiche : D√©lai (ex: "J+7"), Type (Email/T√©l√©phone), Nom de l'√©tape
  - Tri automatique par nombre de jours croissant
- [ ] Configuration par d√©faut :
  - J+7 : Email "Relance amicale"
  - J+14 : Email "Relance s√©rieuse"
  - J+30 : T√©l√©phone (Appel manuel √† effectuer)
- [ ] Boutons d'action par √©tape :
  - Bouton "Modifier" ‚Üí Ouvre modal d'√©dition
  - Bouton "Supprimer" ‚Üí Confirmation + suppression
- [ ] Bouton "Ajouter une √©tape" ‚Üí Ouvre modal de cr√©ation

### 2.9.4 Modal cr√©ation/√©dition d'√©tape
- [ ] Titre : "Ajouter une √©tape" ou "Modifier l'√©tape"
- [ ] Input : D√©lai (nombre de jours apr√®s l'√©ch√©ance)
- [ ] Dropdown : Type d'action
  - Options : "Email", "T√©l√©phone (appel manuel)"
- [ ] Input : Nom de l'√©tape (ex: "Relance amicale")
- [ ] Si type = "Email" :
  - [ ] Input : Objet de l'email
  - [ ] Textarea : Contenu de l'email (corps du message)
- [ ] Si type = "T√©l√©phone" :
  - [ ] Note informative : "Un reminder sera cr√©√© pour effectuer un appel manuel"
- [ ] Bouton "Annuler"
- [ ] Bouton "Enregistrer" ‚Üí Valide et ferme modal

### 2.9.5 Validation et sauvegarde
- [ ] Bouton "Enregistrer les modifications" (en bas du bloc 3)
- [ ] Toast confirmation : "Param√®tres de relance enregistr√©s"
- [ ] Validation :
  - Chaque √©tape doit avoir un d√©lai unique
  - Le d√©lai doit √™tre > 0
  - Les champs obligatoires doivent √™tre remplis

---

## Backend requis

### 2.9.6 Enrichissement de la table `organizations`
- [ ] Ajouter les champs suivants √† la table `organizations` :
  - `autoSendEnabled` (boolean, optionnel, d√©faut: false)
    - Active/d√©sactive l'envoi automatique des emails de relance
  - `reminderSteps` (array, optionnel) :
    - `id` (string) : Identifiant unique de l'√©tape (UUID)
    - `delay` (number) : Nombre de jours apr√®s √©ch√©ance
    - `type` (string) : "email" ou "phone"
    - `name` (string) : Nom de l'√©tape
    - `emailSubject` (string, optionnel) : Objet de l'email
    - `emailTemplate` (string, optionnel) : Contenu de l'email

**Valeurs par d√©faut :**
```typescript
autoSendEnabled: false
reminderSteps: [
  { id: "...", delay: 7, type: "email", name: "Relance amicale", emailSubject: "...", emailTemplate: "..." },
  { id: "...", delay: 14, type: "email", name: "Relance s√©rieuse", emailSubject: "...", emailTemplate: "..." },
  { id: "...", delay: 30, type: "phone", name: "Appel manuel" }
]
```

### 2.9.7 Queries & Mutations
- [ ] Query `organizations.getReminderSettings`
  - Args : Aucun (utilise le contexte utilisateur)
  - Returns : `{ autoSendEnabled: boolean, reminderSteps: Step[] }`
  - Retourne la configuration de relance de l'organisation de l'utilisateur

- [ ] Mutation `organizations.updateAutoSendEnabled`
  - Args : `{ enabled: boolean }`
  - Met √† jour le toggle d'envoi automatique
  - Returns : Success

- [ ] Mutation `organizations.updateReminderSteps`
  - Args : `{ steps: Step[] }`
  - Remplace compl√®tement le tableau des √©tapes
  - Validation : D√©lais uniques, > 0, champs obligatoires
  - Tri automatique par d√©lai croissant
  - Returns : Success/error

- [ ] Mutation `organizations.addReminderStep`
  - Args : `{ delay: number, type: string, name: string, emailSubject?: string, emailTemplate?: string }`
  - G√©n√®re un UUID pour `id`
  - Ajoute une nouvelle √©tape et retrie par d√©lai
  - Returns : Updated steps array

- [ ] Mutation `organizations.updateReminderStep`
  - Args : `{ stepId: string, ...updatedFields }`
  - Met √† jour une √©tape existante par son ID
  - Returns : Updated steps array

- [ ] Mutation `organizations.deleteReminderStep`
  - Args : `{ stepId: string }`
  - Supprime une √©tape par son ID
  - Returns : Updated steps array

---

## Notes techniques

- **Tri des √©tapes** : Toujours afficher les √©tapes tri√©es par d√©lai croissant
- **Toggle d'envoi automatique** : N'affecte que l'envoi des emails, pas la cr√©ation des reminders
- **Validation frontend** : V√©rifier les d√©lais uniques et positifs avant soumission
- **Templates par d√©faut** : Pr√©voir des templates d'email par d√©faut pour les √©tapes standards
